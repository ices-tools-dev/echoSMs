100  REM      PRGM 'DCVL FISH ECHO 4/22/85'110 D$ =  CHR$ (4): REM  CTRL-D120  DIM B(50),FL(90),WT(90),WF(90),WE(50),EB(50),E(64),WL(50),A(50),EA(50),EF(30),X(10),Y(10)130 PI = 4 *  ATN (1):LD = 1 /  LOG (10)140  REM  FILE FORMAT 'PDF FISH FILE'150  PRINT "DECONVOLVE FISH ECHOS"160  PRINT "DATA ENTER FROM FILE"170  PRINT " AFTER COMPUTATIONS MENU GIVES RESULTS"180  REM  DECONVOLUTION OF FISH ECHO PDF,C.S.CLAY, J ACOUST SOC AM VOL 73,1989-1994 (1983)190  REM   FOR THE PRGM: I MAKE SOME ALTERATIONS OF NOTATION TO HANDLE UPPER-LOWER CASE LETTER DUPLICATIONS.200  REM 210  REM     DECONVOLVE PROGRAM HAS 6 PARTS220  REM          1) READ FISH ECHO FILE.CALC SYSTEM PARAMETERS230  REM          FORMAT PDF FISH FILE240  REM 250  REM          2) SMOOTH-INTERPOLATE260  REM 270  REM          3) COMPUTE WE(E), ECHO PDF FROM 'RAW' EXPERIMENTAL ECHO AMPLITUDE DISTRIBUTION EF(E).280  REM  ECHO AMPLITUDES MUST BE EQUALLY SPACED ON A LOG SCALE.290  REM  ECHO AMPLITUDES CAN BE ENTERED AS A 'READ FILE' OR AS DATA IN THE PRGM.300  REM  SONAR SYSTEM PARAMETERS ENTER HERE310  REM 320  REM         4) COMPUTE WT(B), PDF OF ECHO AMPLITUDE B DUE TO SONAR BEAM PATTERN.330  REM   WT(B) COMES FROM EVALUATION FOR THE TRANSDUCER. ONE CAN USE EHRENBERG'S APPROXIMATION. EQ(8,9),CLAY 1983340  REM     WT(B)=(AG*B^H)/(K*RT)^2. K=2*PI*F/C. RT=CIRCULAR TRANSDUCER RADIUS. G AND H ARE CONSTANTS. THESE CONSTANTS ARE EMPRICAL. VALUES FOR OUR 120 KHZ TRANSDUCER ARE AG=2.08 AND H=-.793.350  REM 360  REM        5) COMPUTE DECONVOLUTION370  REM   WF(E) , PDF OF ECHO AMPLITUDES AFTER REMOVING EFFECT OF TRANSDUCER.380  REM  USE RECURSIVE ALGORITHM TO DO LONG DIVISION OF POLYNOMIALS.390  REM 400  REM           6) MENU FOR OUTPUT410  REM 420  PRINT 430  REM 440  REM        1) READ RAW FISH ECHO FILE450  REM 460  PRINT D$,"PR#0"470  PRINT 480  PRINT "ENTER 'HC' FOR HARD COPY OF FILE"490  PRINT "ANY LETTER TO CONTINUE"500  INPUT P$510  IF P$ = "HC" THEN  PRINT D$,"PR#1"520  REM  ENTER DATA530  REM    READ THE FILE ON DISK 1 OR 2540  PRINT " READ FILE NAMED": INPUT N$550  PRINT "   ON FLOPPY '1' OR '2' ";: INPUT F$560  PRINT D$;"OPEN";N$;",D";F$570  PRINT D$;"READ";N$580  INPUT SF: REM   SONAR FREQ590  INPUT SS: REM   SOUND SPEED600  INPUT RT: REM   RAD TRNSDUCER610  INPUT R1: REM   RANGES R1 ,R2620  INPUT R2630  INPUT MP: REM   NO OF PINGS640  INPUT E0: REM   MAX RAW ECHO PROC AMP650  INPUT DE: REM   DELTA E660  INPUT MS: REM   NO AMP BINS670  INPUT GS: REM   SONAR GAIN SET.ALL PARAMETERS IN DB680  INPUT SL: REM   SOURCE LEVEL690  INPUT RL: REM   RCV TRNS LEVEL700  INPUT TVG: REM   TVG 40 OR 20710  INPUT MR: REM   MAX TVG RANGE720  INPUT G1: REM   GAIN AT 1 M730  INPUT PG: REM   PROCESSOR GAIN.LINEAR FOR PG,PV,TR740  INPUT PV: REM   PROC VOLT CALIB750  INPUT TR: REM   TAPE REC GAIN880  FOR J = 0 TO MS - 1890  INPUT E(J)900  NEXT J910  INPUT IT: REM  TEXT920  PRINT 930  FOR J = 0 TO IT - 1940  INPUT A$(J)950  PRINT A$(J)960  NEXT J970  PRINT D$;"CLOSE";N$980  PRINT 990  PRINT D$,"PR#0"1000  PRINT 1010  REM  DEFAULTS FOLLOW1020 ND = 201030 SM = 71040 HJ = MS - 11050 LJ = 11060  REM 1070  REM       2) SMOOTH-INTREPOLATE1080  REM 1090  REM  LEAST SQUARES CALC1100  REM 1110  REM  LEAST SQUARE INTERPOLATION AND SMOOTHING OF FISH ECHO PDFS.1120  REM  PURPOSE : TO READ VALUES AT EQUALLY SPACED POINTS ON LOG SCALE FOR DECONVOLUTION PRGMS.1130  REM  INPUT IS ON LINEAR SCALE.1140  REM   INPUT E(N) FROM ECHO PROCESSER HAS ECHO AMPLITUDES 0 TO 31.1150  REM   WHOLE CALC IS IN A LONG LOOP ON J=0 TO JH.1160  PRINT "INTERPOLATION TO EQUAL SPACED"1170  PRINT "STEPS ON LOG SCALE"1180  REM     LEAST SQRS SMOOTHS OVER SM TERMS.THE RANGE,0 TO SM,IS IN J LOOP. SM IS EVEN.1190  PRINT "HIGH J=";HJ;"  LOW J=";LJ;" NO DATA=";ND1200  PRINT "SMOOTH OVER ";SM;" STEPS"1210  PRINT  TAB( 1);"INPUT 'M' TO GOTO 'MENU' FOR NEW"1220  PRINT "PARAMETERS"1230  PRINT " ANY KEY TO CONTINUE"1240  INPUT Q$1250  IF Q$ = "M" THEN 2910: REM  GOTO MENU1260  REM  MENU RETURN1270  REM   PDF VALUES AT E=E0*EXP(-J*AL), WHERE AL=LOG(10)/ND. ND SAMPLES/DECADE.1280  REM  INPUT PARAMETERS:1290 AL =  LOG (10) / ND1300 E0 = HJ + .51310 LE0 =  LOG (E0)1320 BJ =  INT ( -  LOG ((LJ + .5) / E0) / AL)1330  FOR J = 0 TO BJ1340 B(J) = E0 *  EXP ( - J * AL)1350  NEXT J1360  REM  STEP 11370  REM  SUM E(J) IN APPROXIMATE LOG SPACED BUCKETS. THEN AVERAGE S/(M1-M2) TO KEEP SAME DELTA E, DE.1380 M = HJ1382  FOR J = 0 TO BJ1383 EA(J) = 0:A(J) = 01384  NEXT J1390  FOR J = 0 TO BJ1400 S = 01410 I = 01420 M1 = M1430  IF M =  < LJ THEN 15101440 M = M - 11450 S = S + E(M) / 2 + E(M + 1) / 21460 I = I + 11470  IF M + .5 >  = B(J + 1) THEN 14301480  IF M = LJ THEN OJ = J1490 EA(J) = S / I1500 A(J) = M1 + .5 - I / 21510  NEXT J1520 BJ = OJ1522  FOR J = 0 TO 101523 X(J) = 01524 Y(J) = 01525  NEXT J1530  PRINT "J     A(J)    EA(J)"1540  FOR J = 0 TO BJ1550  PRINT J; TAB( 7);A(J); TAB( 17);EA(J)1560  NEXT J1570  GET Q$1580  REM  LEAST SQUARES CALC1590  PRINT 1600  PRINT " J"; TAB( 5);"ECHO AMP"; TAB( 20);"ECHO FREQ"1610  REM  LOOP ON J1620 LE0 =  LOG (E0)1630 J = 01640  FOR M = 0 TO SM1650 X(M) =  LOG (A(M))1660  IF EA(M) > 0 THEN Y(M) =  LOG (EA(M))1670  NEXT M1680  GOSUB 19601690  FOR I = 0 TO SM / 21700 E = LE0 - I * AL1710 EE = A + B * E + C * E ^ 21720 EF(I) =  EXP (EE)1730  NEXT I1740  FOR J = SM / 2 + 1 TO BJ - SM / 21750  FOR M = 0 TO SM1760 X(M) =  LOG (A(J + M - SM / 2))1765 E = EA(J + M - SM / 2)1770  IF E > 0 THEN Y(M) =  LOG (E)1780  NEXT M1790  GOSUB 19601800 E = LE0 - J * AL1810 EE = A + B * E + C * E ^ 21820 EF(J) =  EXP (EE)1830  NEXT J1840  FOR J = BJ - SM / 2 TO BJ1850 E = LE0 - J * AL1860 EE = A + B * E + C * E ^ 21870 EF(J) =  EXP (EE)1880  NEXT J1890  FOR J = 0 TO BJ1900  PRINT J; TAB( 5);B(J); TAB( 20);EF(J)1910  NEXT J1920  REM 1930  REM  ------- LEAST SQUARES INTREPOLATION-----1940  REM   SUBROUTINE1950  GOTO 2190: REM    PART (3)1960 N = SM + 11970 Y1 = 0:Y2 = 0:Y3 = 0:X1 = 01980 X2 = 0:X3 = 0:X4 = 01990  FOR M = 0 TO SM2000 Y1 = Y1 + Y(M)2010 Y2 = Y2 + Y(M) * X(M)2020 Y3 = Y3 + Y(M) * X(M) ^ 22030 X1 = X1 + X(M)2040 X2 = X2 + X(M) ^ 22050 X3 = X3 + X(M) ^ 32060 X4 = X4 + X(M) ^ 42070  NEXT M2080  REM  SOLVE DETERMINATE2090 D = N * X2 * X4 + X1 * X2 * X3 + X1 * X2 * X3 - X2 ^ 3 - X1 ^ 2 * X4 - N * X3 ^ 22100 A = Y1 * X2 * X4 + X1 * X3 * Y3 + Y2 * X2 * X3 - Y3 * X2 ^ 2 - Y2 * X1 * X4 - Y1 * X3 ^ 22110 A = A / D2120 B = N * Y2 * X4 + Y1 * X2 * X3 + Y3 * X1 * X2 - Y2 * X2 ^ 2 - Y1 * X1 * X4 - N * Y3 * X32130 B = B / D2140 C = N * Y3 * X2 + Y2 * X1 * X2 + Y1 * X1 * X3 - Y1 * X2 ^ 2 - Y3 * X1 ^ 2 - N * Y2 * X32150 C = C / D2160  REM  USE A,B,C TO CALC INTERPOLATION2170  RETURN 2180  NEXT J2190  REM 2200  REM       3) COMPUTE WE(M) FROM EF(M)2210  REM 2220  REM  NF=FISH DENSITY, MP=NO OF PULSES. 2230  REM   TO CHANGE RAW ECHO FREQUENCY TO ECHO PDF, WE(M)*NF=EF(M)*/(DE*VG*MP) 2240  REM  FROM CLAY-MEDWIN 7.5.82250 VG = 6.2832 * (R2 ^ 3 - R1 ^ 3) / 32260 A =  LOG (10) / ND2270  FOR M = 0 TO BJ2280 WE(M) = EF(M) / (DE * VG * MP)2290  NEXT M2300  REM 2310  REM       4) COMPUTE WT(B)2320  REM 2330  PRINT "WT(B)"2340  REM  USE CLAY EQ (8,9).2350  REM  WT(B) IS PROPORTIONAL TO 1/(KR^2)2360  REM  DEFINE KR=K*RT2370 K = 2 * PI * SF / SS2380 KR = K * RT2390  REM   USE EHRENBERGS APPROXIMATION WITH A MODIFICATION, B GOES TO (B+CONST).2400  REM  MY TESTS ON EXACT WT(B) FOR CIRCULAR PISTON TRANSDUCER REQUIRE 3 SEGMENTS OF APPROXIMATION.2410  REM  APPROXIMATION ERRORS ARE 1 % OR LESS. APPROX APPEARS TO MATCH SIMRAD 120 KHZ QUITE WELL.2420  REM  EFFECTIVE K*RT =18.3 AND NOMINAL FROM RT AND FREQ IS 22.3.2430 K2 = KR ^ 22440 M0 = 2 * ND + 1: REM  SET MIN VALUE OF B TO ABOUT .008. SMALLER VALUES GIVE POOR WT(B).2450  FOR M = 0 TO M02460 B =  EXP ( - M * A)2470  IF B >  = .5097 THEN WT(M) = 2.0289 * (B + .017) ^  - .85 / K22480  IF B < .5097 THEN WT(M) = 2.0361 * (B + .007) ^  - .82 / K22490  IF B <  = .029 THEN WT(M) = 1.8579 * (B + .0032) ^  - .82 / K22500  NEXT M2510  PRINT 2520  REM 2530  REM       5) DECONVOLUTION2540  REM 2550  REM  DECONVOLVE WE(E) TO GET WF(E)2560  REM  USE RECURSIVE POLYNOMIAL LONG DIVISION ALGORITHM.2570  PRINT 2580  PRINT "DECONVOLVE WE(E)/WT(B)"2590 WF(0) = WE(0) / WT(0)2600  FOR J = 1 TO BJ2610 S = 02620  FOR M = 1 TO M02630 SC = 02640  IF J >  = M THEN SC = WT(M) * WF(J - M)2650 S = S + SC2660  NEXT M2670 WF(J) =  - S / WT(0)2680  IF J < M0 THEN WF(J) = WF(J) + WE(J) / WT(0)2690  NEXT J2700  REM  --- END DCVL -----2710  REM 2720  REM  INCLUDE A FOR SUMMATION STEPS2730  REM   CALIB FACTOR FOR ECHO AMPLITUDES2740 R = (R1 + R2) / 22750  IF R > MR THEN CF = CS * PC * R ^ 2 / MR ^ 22760  REM    USE R.H.LOVE, J.ACOUST SOC AM 62,1397-1403(1977) TO CONVERT BACKSCATTERING LENGTH (BSL) TO FISH LENGTH (FL) USING EMPERICAL EQ.2770  REM    LOVE EQ 1, 4*PI*BSL^2/WL^2=AI*(FL/WL)^BI. WL=WAVE LENGTH,AI=5.6E-1,BI=1.88 .DORSAL ASPECT.2780 AI = 5.6E - 22790 BI = 1.882800  REM    BSL=CF*B(J). SOLVE LOVE EQ FOR FL. GET FL=KE*B(J)^2/BI WITH NEW CONSTANTS.LET B=2/BI.2810 KD = (4 * PI / AI) ^ (1 / BI)2820 WL = SS / SF: REM  ACOUSTIC WAVELENGHT2830 B = 2 / BI2840 KE = KD * WL ^ (1 - B) * CF ^ B2850  REM  COMPUTE WF(J) WITH 1/A FACTOR2860  REM   COMPUTE FISH LENGTH FL(J)=KE*B(J)^B.UNITS ARE SAME AS WL,M2870  FOR J = 0 TO BJ2880 WF(J) = WF(J) / A2890 FL(J) = KE * B(J) ^ B2900  NEXT J2910  PRINT "FILES AND RESULTS-MENU"2920 P$ = "0": REM  SET HARD COPY INST TO NO HC2930  PRINT "   'HC' FOR HARD COPY"2940  PRINT "   'SP' FOR TEXT AND SONAR PARAMETERS"2950  PRINT "   'E'  FOR INPUT FILE E(J)"2960  PRINT "   'EF' FOR INTERPOLATED EF(J)"2970  PRINT "   'WF' FOR WF(J) AND FISH DENSITY"2980  PRINT "   'CC' TO CONT CALC"2990  PRINT "   'NC' FOR NEW CALC"3000  PRINT "   'NF' TO ENTER NEW FILE"3005  PRINT "   'MF' TO WRITE OUTPUT FILE"3010  PRINT "   'M'  FOR MENU"3020  PRINT "   'Q'  TO QUIT"3030  PRINT "MENU"3040  INPUT Q$3050  IF Q$ = "HC" THEN 31603060  IF Q$ = "SP" THEN 31903070  IF Q$ = "E" THEN 34403080  IF Q$ = "EF" THEN 35903090  IF Q$ = "WF" THEN 37303100  IF Q$ = "CC" THEN 12603110  IF Q$ = "NC" THEN 39603120  IF Q$ = "NF" THEN 4403125  IF Q$ = "MF" THEN 50003130  IF Q$ = "M" THEN 29103140  IF Q$ = "Q" THEN 41603150  GOTO 30303160  REM  HARD COPY CONTROL3170 P$ = "HC"3180  GOTO 30303190  REM  ------ PRINT SONAR PARAMETERS3200  REM 3210  IF P$ = "HC" THEN  PRINT D$,"PR#1"3220  FOR J = 0 TO IT - 13230  PRINT A$(J)3240  NEXT J3250  PRINT 3260  PRINT "SONAR PARAMETERS"3270  PRINT " SIMRAD EY-M"3280  PRINT "   FREQ =";SF3290  PRINT "   SOUND SPEED=";SS3300  PRINT "   TRANS RADIUS=";RT;" M"3310  PRINT "   SOURCE LEVEL'";SL;" DB, (1MU BAR AT 1 M)"3320  PRINT "   RCV TRNS=";RL;" DB"3330  PRINT "   RCV GAIN SET=";GS3340  PRINT "   TVG=";TVG;" LOG(R) DB"3350  PRINT "   CALIB SONAR GAIN AT 1 M="; INT (10 * G1 + .5) / 10;" DB"3360  PRINT "   RANGES,R1,R2 = ";R1;",";R2;"M"3365  PRINT "   TOTAL NO. PINGS=";MP3370  PRINT "   PROCESSER GAIN=";PG3380  PRINT "   E0=";E03390  PRINT "   DELTA E=";DE3400  PRINT "   TAPE REC.GAIN=";TR3405  PRINT "   SYSTEM CALIB.=";CF3410 P$ = "0": REM   RESET HARD COPY INST.3420  PRINT D$,"PR#0"3430  GOTO 30303440  REM   ------  AND E(J)3450  REM 3460  IF P$ = "HC" THEN  PRINT D$,"PR#1"3470  FOR J = 0 TO IT3480  PRINT A$(J)3490  NEXT J3500  PRINT "R1,R2=";R1;",";R2;" NO PINGS=";MP3510  PRINT "J"; TAB( 5);"E(J)"; TAB( 13);"J"; TAB( 20);"E(J)"3520 M =  INT (MS / 2 - 1 + .5)3530  FOR J = 0 TO M3540  PRINT J; TAB( 5);E(J); TAB( 13);M + 1 + J; TAB( 20);E(M + 1 + J)3550  NEXT J3560 P$ = "0"3570  PRINT D$,"PR#0"3580  GOTO 30303590  REM   INTERPOLATED FILE3600  IF P$ = "HC" THEN  PRINT D$,"PR#1"3610  PRINT "LOW J=";LJ3620  PRINT "HIGH J=";HJ3630  PRINT "SMOOTH OVER SM=";SM3640  PRINT 3650  PRINT " J"; TAB( 5);"ECHO AMP"; TAB( 20);"ECHO FREQ"3660  FOR J = 0 TO BJ3670  PRINT J; TAB( 5);B(J); TAB( 20);EF(J)3680  NEXT J3690  PRINT 3700 P$ = "0"3710  PRINT D$,"PR#0"3720  GOTO 30303730  REM  PRINT FISH PDF WF(J)3740  IF P$ = "HC" THEN  PRINT D$,"PR#1"3745  PRINT N$3750  PRINT 3760  PRINT "M"; TAB( 5);"E(M)"; TAB( 23);"WF(M)"3765  PRINT 3770  FOR J = 0 TO BJ3790 B =  INT (100 * B(J)) / 1003800  PRINT J; TAB( 5);B; TAB( 12); TAB( 21);WF(J)3810  NEXT J3820  PRINT 3830  PRINT "SMOOTH=";SM;"  LOW J=";LJ;"  HIGH J=";HJ;" STEPS/DECADE=";ND3840  PRINT 3920  PRINT 3930 P$ = "0"3940  PRINT D$,"PR#0"3950  GOTO 30303960  REM  NEW PARAMETERS FOR NEW CALC3970  IF P$ = "HC" THEN  PRINT D$,"PR#1"3980  PRINT "OLD INTERP AND SMOOTHING PARM"3990  PRINT "STEPS / DECADE=";ND4000  PRINT "           NEW=";: INPUT ND4010  PRINT "NO OF STEPS=";BJ4020  PRINT "        NEW=";: INPUT BJ4030  PRINT "SMOOTH OVER ";SM;" STEPS"4040  PRINT "         NEW=";: INPUT SM4050  PRINT "ECHO AMPL INDEX"4060  PRINT "OLD LOW J=";LJ4070  PRINT "      NEW=";: INPUT LJ4080  REM   BIG NOISE AMPLITUDES CAN GIVE BAD INTREPOLATIONS.4090  PRINT "SYSTEM OVERLOAD GIVES POOR VALUES FOR J=31"4100  PRINT "PRESENT HJ=";HJ4110  PRINT "       NEW=";: INPUT HJ4120  PRINT 4130 P$ = "0"4140  PRINT D$,"PR#0"4150  GOTO 30304160  END 5000  REM  ------- WRITE FILE---5005  PRINT "OLD NAME =";N$5006  PRINT "NEW FILE=";: INPUT NN$5010  REM 5020  REM  WRITE THE FILE ON DISK 1 OR 25030  PRINT "WRITE FILE"5040  PRINT "   ON FLOPPY '1' OR '2' ";: INPUT F$5050  REM  CLEAN FILE5060  PRINT D$;"OPEN";NN$;",D";F$5070  PRINT D$;"DELETE";NN$5075  PRINT D$;"OPEN";NN$5080  PRINT D$;"WRITE";NN$5090  PRINT SF: REM  SONAR FREQ5100  PRINT SS: REM  SOUND SPEED5110  PRINT RT: REM  RAD TRNSDUCER5120  PRINT R1: REM  RANGES R1 ,R25130  PRINT R25140  PRINT MP: REM  NO OF PINGS5150  PRINT E0: REM  MAX RAW ECHO PROC AMP5160  PRINT DE: REM  DELTA E5170  PRINT BJ: REM   NO AMP BINS5180  PRINT GS: REM  SONAR GAIN SET5190  PRINT SL: REM  SOURCE LEVEL5200  PRINT RL: REM  RCV TRNS LEVEL5210  PRINT TVG: REM  TVG 40 OR 205220  PRINT MR: REM  MAX TVG RANGE5230  PRINT G1: REM  GAIN AT 1 M5240  PRINT PG: REM  PROCESSOR GAIN5250  PRINT PV: REM  PROC VOLT CALIB5260  PRINT TR: REM  TAPE REC GAIN5270  PRINT ND: REM  STEPS/DECADE5280  FOR J = 0 TO BJ5290  PRINT WF(J)5300  NEXT J5310  PRINT I5320  FOR J = 0 TO I - 15330  PRINT A$(J)5340  NEXT J5350  PRINT D$;"CLOSE";NN$;5360  GOTO 3030: REM  MENU5370  REM 